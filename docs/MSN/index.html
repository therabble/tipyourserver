<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/w3.css"> <!-- NB: global styles dir, fork to localize -->
  </head>

  <style>
    body {
      text-align: center;
      font-family: Helvetica, San-Serif;
      background-color: #444;
      background-image: url("../images/greenwindows_small.jpg"); /* NB: global images dir, fork to localize */
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
    }
    #bigwrapper {
      max-width:1000px;
      display:inline-block;
      margin-top:20px;
      margin-bottom:20px;
      text-align:center;
      background-color:#f0f0f0;
    }
    #loading {
      color:#ccc;
    }
    #form {
      display: none;
      margin:5px;
      /*padding-bottom:10px;*/
    }
    #result {
      margin-top:-10px;
      display: none;
    }
    #userlist {
      /*background-color:#f7f7f7;*/
      /*border:solid;*/
      /*border-width: 1px;*/
      padding:10px;
      margin:10px;
      border-color:#ccc;
      max-width:980px;
      display:inline-block;
      text-align:left;
    }
    #howmany {
      width:50px;
    }
    #maincopy {
      max-width:600px;
      margin: 0 auto;
      margin-top: 10px;
      padding-left:10px;
      padding-right:10px;
      /*font-size:smaller;*/
      color:#666;
    }
    #establishmentList {
      width:300px;
      margin-bottom:15px;
    }
    #randomizeControls {
      display:block;
    }
    .userrecord {
      margin:10px;
      padding:5px;
      -webkit-backface-visibility: hidden;
      background-color:#fafafa;
      /*transition: 1.5s;*/
    }
/*    .userrecord:nth-of-type(6n+0) {
      transform: rotate(1.5deg);
    }
    .userrecord:nth-of-type(6n+1) {
      transform: rotate(-1deg);
    }
    .userrecord:nth-of-type(6n+2) {
      transform: rotate(-1.5deg);
    }
    .userrecord:nth-of-type(6n+3) {
      transform: rotate(0.5deg);
    }
    .userrecord:nth-of-type(5n+4) {
      transform: rotate(-0.25deg);
    }
    .userrecord:nth-of-type(5n+5) {
      transform: rotate(0.5deg);
    }*/
    .userrecord:hover {
      /*transform: rotate(0deg);*/
      background-color:#fff;
      /*transition: 0.5s;*/
    }
    .idblock {
      display: inline-block;
      width:300px;
      max-width:400px;
      float:left;
    }
    .linklist {
      display: inline-block;
      vertical-align: text-top;
      max-width:580px;
      padding-top:10px;
      text-align:center;
    }
    .linkblock {
      display: inline-block;
      vertical-align: text-top;
      width:200px;
      max-width:580px;
      padding-top:10px;
      float:left;
      text-align:center;
    }
    .clearblock {
      clear: both;
      height:1px;
      width:1px;
    }
    .name {
      font-size:larger;
      font-weight:bold;
    }
    .establishment {
      font-size:smaller;
      margin-left:10px;
    }
    .closed {
      font-size:smaller;
      margin-left:10px;
    }
    .label {
      color: #888;
    }
  </style>

  <body class="">
    <div id="bigwrapper" class="w3-card-2 w3-round-large">

      <header class="w3-container w3-blue w3-round-large">
        <h1>Madison Tip Jar Randomizer</h1>
        <div id="relatedsites" class="linklist">
          <a href="https://docs.google.com/document/d/e/2PACX-1vRfSxHaPuUEnRqQmunDI5UsVAoPk6FC6-NCvMlyWWsarfdB6_wDn15RgaNnyMNNMKUvZOc2PV5nUJjH/pub?fbclid=IwAR0MUIb-_g1mGW-Sb-8lfbLGHX-tlr2baU-ZpsUqebYQ4t2f7-WbKMnTBQ">Madison Tip Jar Sign Up</a>
          |
          <a href="/">tipyourserver.org home</a>
        </div>
        <br><br>
      </header>

      <p id="maincopy">In order to help keep things with the <a href="https://docs.google.com/document/d/e/2PACX-1vRfSxHaPuUEnRqQmunDI5UsVAoPk6FC6-NCvMlyWWsarfdB6_wDn15RgaNnyMNNMKUvZOc2PV5nUJjH/pub?fbclid=IwAR0MUIb-_g1mGW-Sb-8lfbLGHX-tlr2baU-ZpsUqebYQ4t2f7-WbKMnTBQ">Madison Virtual Tip Jar</a> fair and unbiased, this picks one or more people off the list completely at random. That way you can help someone that needs it without having to make any assessments of the whole list.</p>
      <br>
      <div id="loading">Loading list of participants...</div>

      <div id="form" class="w3-center">
          From <select id="establishmentList" class="w3-select" name="option" onchange="updateCount()">
            <option value="" selected>Any Establishment</option>
          </select>
          <div id="randomizeControls">
            <label for="fname">How many random tip links <span id="outof"></span>would you like to see?</label><br>
            <input type="text" id="howmany" name="howmany" value="1"><br><br>
            <button onclick="randomSearch()" class="w3-button w3-green w3-round-large">Tip Someone</button>
          </div><br>
      </div>

      <div id="result">
        Result
      </div>
    </div>
  </body>

  <script>
    // let dataSource = "https://madison-tips.now.sh/api/people";
    let dataSource = "https://api.tipyourserver.org/api/people";

    let dataList = [];
    let establishmentHash = {};
    let establishmentList = [];
    let loadingElement = document.getElementById("loading");
    let formElement = document.getElementById("form");
    let resultElement = document.getElementById("result");
    let outOfElement = document.getElementById("outof");
    let howManyElement = document.getElementById("howmany");
    let establishmentPulldownElement = document.getElementById("establishmentList");

    _getDataFrom(dataSource).then(data => {
      dataList = data.people;
      console.log("which is",dataList.length,"records long.");
      loadingElement.style.display = "none";
      formElement.style.display = "inline-block";
      outOfElement.innerHTML = "(out of " + dataList.length + ") ";
      for(var i=0;i<dataList.length;i++) {
        let key = _standardizeKey(dataList[i].establishment);
        let title = _titleCase(dataList[i].establishment);
        if (!establishmentHash[key]) {
          establishmentHash[key] = [];
          establishmentList.push(title);  //we'll use the first title we find, right or wrong.
        }
        establishmentHash[key].push(dataList[i]);
      }
      establishmentList.sort();


      console.log("establishments:",establishmentList);

      let establishPulldownHTML = '<option value="">Any Establishment</option>';
  
      let pathParts = window.location.pathname.split('/');
      let slug = pathParts[pathParts.length-1];
  
      for(var i=0;i<establishmentList.length;i++) {        
        establishPulldownHTML += '<option value="';
        establishPulldownHTML += _standardizeKey(establishmentList[i]);
        if (establishmentList[i] == slug) {
          establishPulldownHTML += '" selected>';
        } else {
          establishPulldownHTML += '">';
        }
        establishPulldownHTML += establishmentList[i];
        establishPulldownHTML += '</option>';
      }
      establishmentPulldownElement.innerHTML = establishPulldownHTML;
    }).catch(error => {
      console.error(error);
    });

    async function _getDataFrom(url) {
      try {
        const response = await fetch(url, {

          method: 'GET', // *GET, POST, PUT, DELETE, etc.
          //mode: 'no-cors',
          cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
          headers: {
              'Accept': 'application/json',
             // 'cache-control': 'max-age=0',
              },
          });
       // const response = await fetch(url, {mode: 'no-cors'});
        // if(!response.ok) // check if response worked (no 404 errors etc...)
        //  throw new Error(response.statusText);

        const data = await response.json(); // get JSON from the response
        return data; // returns a promise, which resolves to this data value
      } catch(error) {
        console.log("throwing error: " + error);
        return error;
      }
    }

    function _standardizeKey(string) {
      if(!string) string="unknown";
      let stringClear = string.toLowerCase().replace(/[^a-z]/g,"");
      //console.log("key:",stringClear);
      return stringClear;
    }

    function _titleCase(string) {
      let stringClear = string.trim();
      if(!stringClear) stringClear="Unknown";
      // var sentence = stringClear.toLowerCase().split(" ");
      // for(var i = 0; i< sentence.length; i++){
      //    sentence[i] = sentence[i][0].toUpperCase() + sentence[i].slice(1);
      // }
      // return sentence.join(" ");
      return stringClear;
   }

   function updateCount() {
    let filter = establishmentPulldownElement.value
    console.log("list changed to",filter);
    let count=0;
    if(!filter) {
      count = dataList.length;
      outOfElement.innerHTML = "(out of " + count + ") ";
      randomizeControls.style.display="block";
      resultElement.style.display = "none";
    } else {
      //count = establishmentHash[filter].length;
      randomizeControls.style.display="none";
      randomSearch();
    }
   }

    function randomSearch() {
      let htmlBuild = "<div id='userlist'>";
      let whichToRemove = null;
      let howMany = Number(howManyElement.value);
      let filter = establishmentPulldownElement.value;

      console.log(howMany,"from",filter);

      let workList = [];
      if (!filter) {
        workList = dataList;
      } else {
        workList = [...establishmentHash[filter]];
        howMany = workList.length;
      }

      for(i=0;i<(Math.floor(Math.random()*5));i++) {
        htmlBuild += "<div class='userrecord w3-card-2' style='display:none;'></div>";
        //adds some random invisible divs so the first card shows at a different angle each time
      }

      if (howMany > workList.length) howMany = workList.length;

      for(i=0;i<howMany;i++) {
        whichToRemove = Math.floor(workList.length * Math.random());
        var aRecord = workList[whichToRemove];
        console.log(aRecord);
        workList.splice(whichToRemove,1);
        outOfElement.innerHTML = "(out of " + workList.length + ") ";
        htmlBuild += "<div class='userrecord w3-card-4 w3-round'>";
        htmlBuild += "<div class='idblock'>";
        htmlBuild += "<span class='name'>" + aRecord.name + "</span>";
        htmlBuild += "<br><span class='establishment'>" + aRecord.establishment + "</span>";
        htmlBuild += "<br><span class='closed'><span class='label'>Closed?</span> " + aRecord.haveClosed + "</span>";
        htmlBuild += "</div><div class='linkblock'>"

        // if(aRecord.venmoUser) {
        //   htmlBuild += "<span class='venmo'><span class='label'>Venmo User:</span> " + aRecord.venmoUser + "</span><br>";
        // }
        // if(aRecord.paypalUser) {
        //   htmlBuild += "<span class='paypal1'><span class='label'>Paypal User:</span> " + aRecord.paypalUser + "</span><br>";
        // }
        if(aRecord.venmoURL) {
          htmlBuild += '<a class="w3-button w3-blue w3-round-large" href="';
          htmlBuild += aRecord.venmoURL;
          htmlBuild += '" target="_blank">';
          htmlBuild += 'Venmo';
          htmlBuild += "</a> ";
        }
        if(aRecord.paypalURL) {
          // htmlBuild += "<span class='paypal2'><span class='label'>Paypal Link:</span> " + aRecord.paypalURL + "</span><br>";
          htmlBuild += '<a class="w3-button w3-indigo w3-round-large" href="';
          htmlBuild += aRecord.paypalURL;
          htmlBuild += '" target="_blank">';
          htmlBuild += 'PayPal';
          htmlBuild += "</a>";
        }
        htmlBuild += "</div><div class='clearblock'></div><br></div>";
      }
      htmlBuild += "</div>";
      resultElement.innerHTML = htmlBuild;
      resultElement.style.display = "block";
    }
  </script>
</html>

